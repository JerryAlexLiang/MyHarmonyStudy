import DataModel from '../viewmodel/DataModel';
import StudentListItem from '../view/StudentListItem';
import router from '@ohos.router';
import prompt from '@system.prompt';
import { DataItemBean } from '../viewmodel/DataItemBean';
import CommonConstants from '../common/constants/CommonConstants';
import { StudentCardDialog } from '../view/StudentCardDialog';
import { PreferencesUtil } from '../common/db/PreferencesUtil';
import Logger from '../common/utils/Logger';
import { CustomStudentCardDialog } from '../view/CustomStudentCardDialog';
// import DataItemBean from '../viewmodel/DataItemBean';

const TAG = '[StudentListPage]';

@Entry
@Component
export struct StudentListPage {
  // private studentList: Array<string> = [];
  private studentList2: Array<DataItemBean> = [];

  // ËøîÂõû‰∏ä‰∏ÄÂ±ÇÊï∞ÊçÆ
  @State backMessage: string = '';

  // ÊòØÂê¶ÊòØListÁªÑ‰ª∂Ê®°Âºè
  // ÁªÑ‰ª∂ÂÜÖÁöÑÁä∂ÊÄÅÁÆ°ÁêÜÔºö@State
  @State isListModel: boolean = true;

  // ÊòØÂê¶ÁÇπÂáªÂΩìÂâçItem
  @State clickIndex: number = 0;

  // ÂΩìÂâçList/GridÁÇπÂáªItem
  @State currentClickItemData: DataItemBean = undefined;

  // SwiperÊéßÂà∂Âô®
  private swiperController: SwiperController = new SwiperController();
  @State confirmMessage: string = ""
  @State isShowDialog: boolean = false;

  // ÂºπÁ™óÊéßÂà∂Âô®
  private dialogController: CustomDialogController = new CustomDialogController({
    builder: StudentCardDialog({
      // cancel: () => {
      //   this.showToast('Cancel')
      // },
      // confirm: () => {
      //   this.showToast(this.confirmMessage)
      // },
      // studentData: this.studentList2[0],
      studentData: this.currentClickItemData,
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true,
  })

  // Ë∞ÉÁî®router.back()ÊñπÊ≥ïÔºå‰∏ç‰ºöÊñ∞Âª∫È°µÈù¢ÔºåËøîÂõûÁöÑÊòØÂéüÊù•ÁöÑÈ°µÈù¢ÔºåÂú®ÂéüÊù•È°µÈù¢‰∏≠@StateÂ£∞ÊòéÁöÑÂèòÈáè‰∏ç‰ºöÈáçÂ§çÂ£∞ÊòéÔºå
  // ‰ª•Âèä‰πü‰∏ç‰ºöËß¶ÂèëÈ°µÈù¢ÁöÑaboutToAppear()ÁîüÂëΩÂë®ÊúüÂõûË∞ÉÔºåÂõ†Ê≠§Êó†Ê≥ïÁõ¥Êé•Âú®ÂèòÈáèÂ£∞Êòé‰ª•ÂèäÈ°µÈù¢ÁöÑaboutToAppear()
  // ÁîüÂëΩÂë®ÊúüÂõûË∞É‰∏≠Êé•Êî∂ÂíåËß£Êûêrouter.back()‰º†ÈÄíËøáÊù•ÁöÑËá™ÂÆö‰πâÂèÇÊï∞„ÄÇ
  onPageShow() {
    this.backMessage = router.getParams()?.['backMessage'];
    console.log(TAG, 'StudentDetailPageËøîÂõûÊï∞ÊçÆÔºöStudentListPage => ' + this.backMessage)

    if (this.backMessage != undefined && this.backMessage != "") {
      this.showToast(this.backMessage)
    }
  }

  aboutToAppear() {
    // this.studentList = DataModel.getStudentList();
    this.studentList2 = DataModel.getStudentList2();
    // this.backMessage = router.getParams()?.['backMessage'];

    PreferencesUtil.prototype.getChangeStudentListMode().then((value) => {
      this.isListModel = value;
      Logger.debug(TAG, 'Get the value of isListModel: ' + this.isListModel);
    });
  }

  aboutToDisappear() {
    // Âú®Ëá™ÂÆö‰πâÁªÑ‰ª∂Âç≥Â∞ÜÊûêÊûÑÈîÄÊØÅÊó∂Â∞ÜdialogControlleÂà†Èô§ÂíåÁΩÆÁ©∫
    delete this.dialogController // Âà†Èô§dialogController
    this.dialogController = undefined // Â∞ÜdialogControllerÁΩÆÁ©∫
  }

  showToast(message: string) {
    prompt.showToast({
      message: message
    })
  }

  @Builder NavigationMenus() {
    Row() {
      Toggle({ type: ToggleType.Switch, isOn: this.isListModel })
        .selectedColor(Color.Red)
        .switchPointColor(Color.White)
        .onChange((isOn: boolean) => {
          // this.isListModel = !this.isListModel
          this.isListModel = isOn

          PreferencesUtil.prototype.saveStudentListMode(this.isListModel)
        })
    }
  }

  @Builder SwiperBuilder(studentList: Array<DataItemBean>) {
    Swiper(this.swiperController) {
      ForEach(studentList, (item: DataItemBean) => {
        Image(item.image)
          .borderRadius($r('app.float.home_swiper_borderRadius'))
          .width('100%')
          .height('240vp')
          .objectFit(ImageFit.Fill)
          .onClick(() => {
            router.pushUrl({
              // url: 'pages/StudentDetailPage',
              url: CommonConstants.STUDENT_DETAIL_URL,
              params: {
                studentData: item
              }
            }).catch((error) => {
              console.log('Next Click', 'IndexPage push error' + JSON.stringify(error));
            })
          })
      }, (item: DataItemBean) => JSON.stringify(item))
    }
    .autoPlay(true)
    .indicatorStyle({ mask: true, bottom: '10vp' })
    // .margin({ top: $r('app.float.home_swiper_margin'), bottom: $r('app.float.home_swiper_margin') })
    .margin({ bottom: '10vp' })
  }

  build() {
    Navigation() {
      Stack() {
        Row() {
          if (this.isListModel) {
            Scroll() {
              Column() {
                // SwiperÁªÑ‰ª∂
                this.SwiperBuilder(this.studentList2)
                // ÂàóË°®
                // ListÁªÑ‰ª∂Â≠êÁªÑ‰ª∂ListItem‰πãÈó¥ÈªòËÆ§ÊòØÊ≤°ÊúâÂàÜÂâ≤Á∫øÁöÑÔºåÈÉ®ÂàÜÂú∫ÊôØÂ≠êÁªÑ‰ª∂ListItemÈó¥ÈúÄË¶ÅËÆæÁΩÆÂàÜÂâ≤Á∫øÔºå
                // ËøôÊó∂ÂÄôÂèØ‰ª•‰ΩøÁî®ListÁªÑ‰ª∂ÁöÑdividerÂ±ûÊÄß„ÄÇdividerÂ±ûÊÄßÂåÖÂê´Âõõ‰∏™ÂèÇÊï∞Ôºö
                // 1„ÄÅstrokeWidth: ÂàÜÂâ≤Á∫øÁöÑÁ∫øÂÆΩ„ÄÇ
                // 2„ÄÅcolor: ÂàÜÂâ≤Á∫øÁöÑÈ¢úËâ≤„ÄÇ
                // 3„ÄÅstartMarginÔºöÂàÜÂâ≤Á∫øË∑ùÁ¶ªÂàóË°®‰æßËæπËµ∑ÂßãÁ´ØÁöÑË∑ùÁ¶ª„ÄÇ
                // 4„ÄÅendMargin: ÂàÜÂâ≤Á∫øË∑ùÁ¶ªÂàóË°®‰æßËæπÁªìÊùüÁ´ØÁöÑË∑ùÁ¶ª
                List({ space: 16 }) {
                  ForEach(this.studentList2, (item: DataItemBean, index: number) => {
                    ListItem() {
                      // StudentListItem({ studentData: item, isListModel: true })

                      // Â∞ÜÁà∂ÁªÑ‰ª∂ÁöÑÂàóË°®ÊòæÁ§∫Ê®°ÂºèÁä∂ÊÄÅthis.isListModel‰º†ÈÄíÁªôÂ≠êÁªÑ‰ª∂ÁöÑÁºñËæëÊ®°ÂºèÁä∂ÊÄÅisListModel
                      // Ê≠§Â§ÑÊåáÂÆöÁöÑÂèÇÊï∞ÈÉΩÂ∞ÜÂú®ÂàùÂßãÊ∏≤ÊüìÊó∂Ë¶ÜÁõñÊú¨Âú∞ÂÆö‰πâÁöÑÈªòËÆ§ÂÄºÔºåÂπ∂‰∏çÊòØÊâÄÊúâÁöÑÂèÇÊï∞ÈÉΩÈúÄË¶Å‰ªéÁà∂ÁªÑ‰ª∂ÂàùÂßãÂåñ
                      StudentListItem({
                        studentData: item,
                        index: index,
                        isListModel: this.isListModel,
                        clickIndex: $clickIndex, // Â∏¶Êúâ‚Äú@Link‚ÄùË£ÖÈ•∞ÁöÑÂ±ûÊÄßÂøÖÈ°ªÂàùÂßãÂåñ‰∏∫‚Äú$‚Äù
                        onItemChildImageClick: () => {
                          this.currentClickItemData = item

                          // ‰ΩøÁî®ÁªÑÂÜÖËΩ¨Âú∫Âä®ÁîªËá™ÂÆö‰πâDialog
                          // ÁªÑ‰ª∂ÂÜÖËΩ¨Âú∫Âä®ÁîªÈúÄË¶ÅÈÖçÂêà animateTo ÊâçËÉΩÁîüÊïàÔºåÂä®ÊïàÊó∂Èïø„ÄÅÊõ≤Á∫ø„ÄÅÂª∂Êó∂Ë∑üÈöè animateTo ‰∏≠ÁöÑÈÖçÁΩÆ
                          // üì¢ÔºöÁªÑ‰ª∂ÂÜÖÁöÑËΩ¨Âú∫Âä®ÁîªÊó∂ÈïøÔºåÂä®ÁîªÊõ≤Á∫øÁ≠âÂä®ÁîªÂèÇÊï∞‰ª• animationTo ÊñπÊ≥ïËÆæÁΩÆÁöÑ‰∏∫Âü∫ÂáÜ
                          // ÊòæÁ§∫Âä®Áîª-Ê∑ªÂä†Â±ïÂºÄÂä®Áîª
                          animateTo({ duration: 1000 }, () => {
                            this.isShowDialog = !this.isShowDialog ;
                          })

                          // if (this.dialogController != undefined) {
                          //   this.dialogController.open()
                          //   this.showToast(item.title)
                          // }
                        }
                      })
                    }
                  }, (item, index) => JSON.stringify(item) + index)
                }
                // .width('90%')
                .divider({ strokeWidth: 1, color: Color.Gray, startMargin: 30, endMargin: 0 })
                // .listDirection(Axis.Horizontal)

                Text('---Ê≤°ÊúâÊõ¥Â§ö‰∫Ü---').fontSize('16vp').margin('30vp')
              }
            }
            .scrollBar(BarState.Off)
            .edgeEffect(EdgeEffect.Spring)
          } else {
            Scroll() {
              Column() {
                // SwiperÁªÑ‰ª∂
                this.SwiperBuilder(this.studentList2)

                Grid() {
                  ForEach(this.studentList2, (item: DataItemBean) => {
                    GridItem() {
                      // StudentListItem({ studentData: item, isListModel: false })
                      // Â∞ÜÁà∂ÁªÑ‰ª∂ÁöÑÂàóË°®ÊòæÁ§∫Ê®°ÂºèÁä∂ÊÄÅthis.isListModel‰º†ÈÄíÁªôÂ≠êÁªÑ‰ª∂ÁöÑÁºñËæëÊ®°ÂºèÁä∂ÊÄÅisListModel
                      // Ê≠§Â§ÑÊåáÂÆöÁöÑÂèÇÊï∞ÈÉΩÂ∞ÜÂú®ÂàùÂßãÊ∏≤ÊüìÊó∂Ë¶ÜÁõñÊú¨Âú∞ÂÆö‰πâÁöÑÈªòËÆ§ÂÄºÔºåÂπ∂‰∏çÊòØÊâÄÊúâÁöÑÂèÇÊï∞ÈÉΩÈúÄË¶Å‰ªéÁà∂ÁªÑ‰ª∂ÂàùÂßãÂåñ
                      StudentListItem({
                        studentData: item,
                        isListModel: this.isListModel,
                        clickIndex: $clickIndex, // Â∏¶Êúâ‚Äú@Link‚ÄùË£ÖÈ•∞ÁöÑÂ±ûÊÄßÂøÖÈ°ªÂàùÂßãÂåñ‰∏∫‚Äú$‚Äù
                        onItemChildImageClick: () => {
                          this.currentClickItemData = item

                          // ‰ΩøÁî®Á≥ªÁªüËá™ÂÆö‰πâÂºπÊ°ÜÁªÑ‰ª∂
                          if (this.dialogController != undefined) {
                            this.dialogController.open()
                            this.showToast(item.title)
                          }
                        }
                      })
                    }
                  }, (item: string) => JSON.stringify(item))
                }
                .columnsTemplate('1fr 1fr 1fr')
                .rowsTemplate('1fr 1fr 1fr 1fr 1fr')
                .columnsGap('10vp')
                .rowsGap('10vp')
                .height('640vp')
                // .layoutDirection(GridDirection.Row)

                Text('---Ê≤°ÊúâÊõ¥Â§ö‰∫Ü---').fontSize('16vp').margin('30vp')
              }
            }
            .scrollBar(BarState.Off)
            .edgeEffect(EdgeEffect.Spring)
          }
        }
        .width('90%')
        // .margin({ left: 10, right: 10 })

        if (this.isShowDialog){
          CustomStudentCardDialog({
            studentData: this.currentClickItemData,
            onDialogClick: () => {
              // ÁªÑ‰ª∂ÂÜÖËΩ¨Âú∫Âä®ÁîªÈúÄË¶ÅÈÖçÂêà animateTo ÊâçËÉΩÁîüÊïàÔºåÂä®ÊïàÊó∂Èïø„ÄÅÊõ≤Á∫ø„ÄÅÂª∂Êó∂Ë∑üÈöè animateTo ‰∏≠ÁöÑÈÖçÁΩÆ
              // üì¢ÔºöÁªÑ‰ª∂ÂÜÖÁöÑËΩ¨Âú∫Âä®ÁîªÊó∂ÈïøÔºåÂä®ÁîªÊõ≤Á∫øÁ≠âÂä®ÁîªÂèÇÊï∞‰ª• animationTo ÊñπÊ≥ïËÆæÁΩÆÁöÑ‰∏∫Âü∫ÂáÜ
              // ÊòæÁ§∫Âä®Áîª-Ê∑ªÂä†Â±ïÂºÄÂä®Áîª
              animateTo({ duration: 1000 }, () => {
                this.isShowDialog = !this.isShowDialog ;
              })
            }
          })
        }
      }

    }
    .title('Â≠¶ÁîüÂêçÂçï')
    .size({ width: '100%', height: '100%' })
    .titleMode(NavigationTitleMode.Mini)
    .hideBackButton(true)
    .menus(this.NavigationMenus())
    .backgroundColor($r('app.color.page_background'))
  }
}